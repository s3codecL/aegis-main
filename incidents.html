<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Incidencias - Aegis HUB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <style>
        /* Los estilos de botones se heredan de style.css */
        
        /* Fondos */
        [data-bs-theme="dark"] body {
            background: #000000 !important;
        }

        [data-bs-theme="light"] body {
            background: #ffffff !important;
        }
        
        /* Dark mode - Cards */
        [data-bs-theme="dark"] .card {
            background: rgba(15, 20, 51, 0.6) !important;
            border: 1px solid rgba(59, 130, 246, 0.2) !important;
            border-radius: 1rem !important;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1) !important;
            transition: all 0.3s ease !important;
        }
        
        [data-bs-theme="dark"] .card:hover {
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.25), 
                        0 10px 20px rgba(59, 130, 246, 0.15),
                        0 0 0 1px rgba(59, 130, 246, 0.4) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
            transform: translateY(-8px) scale(1.01) !important;
        }
        
        /* Light mode - Cards */
        [data-bs-theme="light"] .card {
            background: #ffffff !important;
            border: 1px solid rgba(59, 130, 246, 0.2) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
            border-radius: 1rem !important;
            transition: all 0.3s ease !important;
        }
        
        [data-bs-theme="light"] .card:hover {
            background: rgba(255, 255, 255, 1) !important;
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.25), 
                        0 10px 20px rgba(59, 130, 246, 0.15),
                        0 0 0 1px rgba(59, 130, 246, 0.4) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
            transform: translateY(-8px) scale(1.01) !important;
        }
        
        /* Light mode - textos */
        [data-bs-theme="light"] .card h1,
        [data-bs-theme="light"] .card h2,
        [data-bs-theme="light"] .card h3,
        [data-bs-theme="light"] .card .h1 {
            color: #1e293b !important;
        }
        
        [data-bs-theme="light"] .card .text-muted,
        [data-bs-theme="light"] .subheader {
            color: #64748b !important;
        }
        
        /* Light mode - tabla */
        [data-bs-theme="light"] .table {
            color: #1e293b !important;
            background-color: transparent !important;
        }
        
        [data-bs-theme="light"] .table thead th {
            background-color: #f8fafc !important;
            color: #475569 !important;
            border-color: #e5e7eb !important;
        }
        
        [data-bs-theme="light"] .table tbody tr {
            border-color: #e5e7eb !important;
            transition: all 0.2s ease !important;
        }
        
        [data-bs-theme="light"] .table-hover tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.08) !important;
        }
        
        /* Dark mode - Tabla */
        [data-bs-theme="dark"] .table {
            color: #e8eaf6 !important;
        }
        
        [data-bs-theme="dark"] .table thead th {
            background-color: rgba(15, 20, 51, 0.8) !important;
            border-color: rgba(59, 130, 246, 0.2) !important;
        }
        
        [data-bs-theme="dark"] .table tbody tr {
            border-color: rgba(59, 130, 246, 0.1) !important;
        }
        
        [data-bs-theme="dark"] .table-hover tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Badges de criticidad con colores específicos */
        .badge-low { background-color: #28a745 !important; color: white !important; }
        .badge-medium { background-color: #ffc107 !important; color: #000 !important; }
        .badge-high { background-color: #fd7e14 !important; color: white !important; }
        .badge-critical { background-color: #dc3545 !important; color: white !important; }
        
        /* Estilos para filtros */
        .filter-section {
            margin-bottom: 1.5rem;
        }
        
        .filter-section .form-select,
        .filter-section .form-control {
            min-width: 150px;
        }
        
        /* Modal más ancho para formulario de incidencias */
        .modal-xl {
            max-width: 1200px;
        }
        
        /* Accordion para secciones del formulario */
        .accordion-button:not(.collapsed) {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        [data-bs-theme="dark"] .accordion-item {
            background-color: rgba(15, 20, 51, 0.4);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        [data-bs-theme="light"] .accordion-item {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        
        /* Scroll horizontal para tabla en pantallas pequeñas */
        .table-responsive {
            overflow-x: auto;
        }
        
        /* Badge de status con iconos */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
            .status-icon {
                vertical-align: middle;
                margin-left: 0.25rem;
                display: inline-flex;
                align-items: center;
            }
        
        /* Estilos para los badges de prioridad */
        .badge-low {
            background-color: #28a745 !important;
            color: white !important;
        }
        
        .badge-medium {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }
        
        .badge-high {
            background-color: #fd7e14 !important;
            color: white !important;
        }
        
        .badge-critical {
            background-color: #dc3545 !important;
            color: white !important;
        }
        
        /* Estilos para botones del modal */
        .modal-footer .btn-primary {
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
            color: white !important;
            font-weight: 500;
            padding: 0.5rem 1.5rem;
            transition: all 0.2s ease;
        }
        
        .modal-footer .btn-primary:hover {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
        }
        
        .modal-footer .btn-secondary {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: white !important;
            padding: 0.5rem 1.5rem;
        }
        
        .modal-footer .btn-secondary:hover {
            background-color: #5a6268 !important;
            border-color: #545b62 !important;
        }
        
        /* Estilos para botón Nueva Incidencia */
        #newIncidentBtn {
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
            color: white !important;
            font-weight: 500;
            padding: 0.5rem 1.5rem;
            transition: all 0.2s ease;
        }
        
        #newIncidentBtn:hover {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
            transform: translateY(-2px);
        }
        
        #newIncidentBtn .icon {
            transition: transform 0.2s ease;
        }
        
        #newIncidentBtn:hover .icon {
            transform: rotate(90deg);
        }
        
        /* Light mode - Badges de estado más visibles */
        [data-bs-theme="light"] .badge {
            font-weight: 600 !important;
            color: white !important;
        }
        
        /* Light mode - Botones de acción en tabla */
        [data-bs-theme="light"] .table .btn-outline-primary {
            color: #3b82f6 !important;
            border-color: #3b82f6 !important;
            background-color: white !important;
        }
        
        [data-bs-theme="light"] .table .btn-outline-primary:hover {
            color: white !important;
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
        
        [data-bs-theme="light"] .table .btn-outline-danger {
            color: #dc3545 !important;
            border-color: #dc3545 !important;
            background-color: white !important;
        }
        
        [data-bs-theme="light"] .table .btn-outline-danger:hover {
            color: white !important;
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
        }
        
        /* Light mode - SVG icons en botones */
        [data-bs-theme="light"] .table .btn-outline-primary svg {
            fill: #3b82f6 !important;
        }
        
        [data-bs-theme="light"] .table .btn-outline-primary:hover svg {
            fill: white !important;
        }
        
        [data-bs-theme="light"] .table .btn-outline-danger svg {
            fill: #dc3545 !important;
        }
        
        [data-bs-theme="light"] .table .btn-outline-danger:hover svg {
            fill: white !important;
        }
        
        /* Light mode - Colores de números en estadísticas */
        [data-bs-theme="light"] .card .text-primary,
        [data-bs-theme="light"] .text-primary {
            color: #3b82f6 !important;
        }
        
        [data-bs-theme="light"] .card .text-warning,
        [data-bs-theme="light"] .text-warning {
            color: #f59e0b !important;
        }
        
        [data-bs-theme="light"] .card .text-danger,
        [data-bs-theme="light"] .text-danger {
            color: #dc3545 !important;
        }
        
        /* Light mode - H1 con colores específicos */
        [data-bs-theme="light"] .card .h1.text-primary {
            color: #3b82f6 !important;
        }
        
        [data-bs-theme="light"] .card .h1.text-warning {
            color: #f59e0b !important;
        }
        
        [data-bs-theme="light"] .card .h1.text-danger {
            color: #dc3545 !important;
        }
        
        /* Dark mode - Form controls (selects, inputs) */
        [data-bs-theme="dark"] .form-select,
        [data-bs-theme="dark"] .form-control {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
            color: #e8eaf6 !important;
        }
        
        [data-bs-theme="dark"] .form-select:focus,
        [data-bs-theme="dark"] .form-control:focus {
            background-color: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(59, 130, 246, 0.6) !important;
            color: #fff !important;
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25) !important;
        }
        
        [data-bs-theme="dark"] .form-select option {
            background-color: #1e293b !important;
            color: #e8eaf6 !important;
        }
        
        [data-bs-theme="dark"] .form-label {
            color: #e8eaf6 !important;
        }
        
        /* Light mode - Form controls */
        [data-bs-theme="light"] .form-select,
        [data-bs-theme="light"] .form-control {
            background-color: #ffffff !important;
            border-color: #d1d5db !important;
            color: #1e293b !important;
        }
        
        [data-bs-theme="light"] .form-select:focus,
        [data-bs-theme="light"] .form-control:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.15) !important;
        }
        
        [data-bs-theme="light"] .form-label {
            color: #1e293b !important;
        }
    </style>
</head>

<body data-bs-theme="dark">
    <!-- Navbar -->
    <header class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-xxl px-3">
            <div class="navbar-brand d-flex align-items-center">
                <svg class="icon-brand me-2" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1.5" role="img" aria-label="Aegis shield icon">
                    <title>Aegis shield</title>
                    <path d="M12 2l7 4v5c0 5-3.5 9.5-7 11-3.5-1.5-7-6-7-11V6l7-4z" fill="none" stroke="currentColor"
                        stroke-linejoin="round" stroke-linecap="round"></path>
                    <path d="M9.5 10.5c.8.6 1.5.9 2.5.9s1.7-.3 2.5-.9" fill="none" stroke="currentColor" stroke-linecap="round">
                    </path>
                </svg>
                <div class="d-flex flex-column">
                    <h1 class="mb-0" data-i18n="INCIDENT_MANAGEMENT">Gestión de Incidencias</h1>
                    <small class="text-muted" data-i18n="CYBERSECURITY_INCIDENTS">Incidencias de Ciberseguridad</small>
                </div>
            </div>
            
            <div class="ms-auto d-flex align-items-center gap-2">
                <!-- Botón Modo Oscuro/Claro -->
                <button class="btn btn-outline-secondary" id="themeToggle" title="Cambiar tema" aria-label="Toggle theme">
                    <svg id="iconLight" class="icon icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display: none;">
                        <circle cx="12" cy="12" r="4"></circle>
                        <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"></path>
                    </svg>
                    <svg id="iconDark" class="icon icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                    </svg>
                </button>

                <!-- Botón Cambio de Idioma -->
                <button class="btn btn-outline-secondary" id="langToggle" title="Cambiar idioma" aria-label="Change language">
                    <span id="langText">EN</span>
                </button>

                <!-- Dropdown Usuario -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span id="currentUserName">Admin</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="index.html">
                            <svg class="icon me-2" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            </svg>
                            <span data-i18n="DASHBOARD">Dashboard</span>
                        </a></li>
                        <li><a class="dropdown-item" href="admin.html">
                            <svg class="icon me-2" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <polyline points="17 11 19 13 23 9"></polyline>
                            </svg>
                            <span data-i18n="ADMIN_PANEL">Panel Admin</span>
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">
                            <svg class="icon me-2" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            <span data-i18n="LOGOUT">Cerrar Sesión</span>
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="page-wrapper">
        <div class="page-body">
            <div class="container-xxl">
                
                <!-- Header con botón de nueva incidencia -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-lg-end align-items-center">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#incidentModal" id="newIncidentBtn">
                                <svg class="icon me-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span data-i18n="NEW_INCIDENT">Nueva Incidencia</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tarjetas de Estadísticas -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader" data-i18n="TOTAL_INCIDENTS">Total Incidencias</div>
                                </div>
                                <div class="h1 mb-0 mt-2 text-primary" id="totalIncidents">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader" data-i18n="OPEN_INCIDENTS">Abiertas</div>
                                </div>
                                <div class="h1 mb-0 mt-2 text-primary" id="openIncidents">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader" data-i18n="INVESTIGATING">En Investigación</div>
                                </div>
                                <div class="h1 mb-0 mt-2 text-warning" id="investigatingIncidents">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader" data-i18n="CRITICAL_INCIDENTS">Críticas</div>
                                </div>
                                <div class="h1 mb-0 mt-2 text-danger" id="criticalIncidents">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-3 filter-section">
                                    <div class="col-xl-3 col-lg-4 col-md-6">
                                        <label class="form-label" data-i18n="FILTER_BY_STATUS">Filtrar por Estado</label>
                                        <select class="form-select" id="filterStatus">
                                            <option value="">-- Todos --</option>
                                        </select>
                                    </div>
                                    <div class="col-xl-3 col-lg-4 col-md-6">
                                        <label class="form-label" data-i18n="FILTER_BY_CRITICALITY">Filtrar por Criticidad</label>
                                        <select class="form-select" id="filterCriticality">
                                            <option value="">-- Todos --</option>
                                        </select>
                                    </div>
                                    <div class="col-xl-3 col-lg-4 col-md-6">
                                        <label class="form-label" data-i18n="FILTER_BY_TYPE">Filtrar por Tipo</label>
                                        <select class="form-select" id="filterType">
                                            <option value="">-- Todos --</option>
                                        </select>
                                    </div>
                                    <div class="col-xl-3 col-lg-12 col-md-6">
                                        <label class="form-label" data-i18n="SEARCH_INCIDENTS">Buscar</label>
                                        <input type="text" class="form-control" id="searchIncidents" 
                                               data-i18n-placeholder="SEARCH_INCIDENTS_PLACEHOLDER"
                                               placeholder="Código, descripción, IP...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Incidencias -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title" data-i18n="INCIDENTS_LIST">Lista de Incidencias</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th data-i18n="CODE">Código</th>
                                                <th data-i18n="STATUS">Estado</th>
                                                <th style="width:32px"></th>
                                                <th data-i18n="CRITICALITY">Criticidad</th>
                                                <th data-i18n="TYPE">Tipo</th>
                                                <th data-i18n="DESCRIPTION">Descripción</th>
                                                <th data-i18n="AFFECTED_IP">IP Afectada</th>
                                                <th data-i18n="REPORTER">Reportado por</th>
                                                <th data-i18n="ACTIONS">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="incidentsTableBody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted py-4">
                                                    <span data-i18n="NO_INCIDENTS">No hay incidencias registradas</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal: Crear/Editar Incidencia -->
    <div class="modal fade" id="incidentModal" tabindex="-1" aria-labelledby="incidentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="incidentModalLabel" data-i18n="NEW_INCIDENT">Nueva Incidencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="incidentForm">
                        <input type="hidden" id="incidentId" />
                        
                        <!-- Accordion para secciones del formulario -->
                        <div class="accordion" id="incidentFormAccordion">
                            
                            <!-- Sección 1: Información Básica -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingBasic">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapseBasic" aria-expanded="true" aria-controls="collapseBasic">
                                        <strong data-i18n="BASIC_INFO">Información Básica</strong>
                                    </button>
                                </h2>
                                <div id="collapseBasic" class="accordion-collapse collapse show" 
                                     aria-labelledby="headingBasic" data-bs-parent="#incidentFormAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="DESCRIPTION">Descripción</span> <span class="text-danger">*</span>
                                                </label>
                                                <textarea class="form-control" id="incidentDescription" rows="3" required
                                                          data-i18n-placeholder="DESCRIPTION_PLACEHOLDER"
                                                          placeholder="Descripción breve del incidente"></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="REPORTER">Reportado por</span> <span class="text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="incidentReporter" required
                                                       data-i18n-placeholder="REPORTER_PLACEHOLDER"
                                                       placeholder="Nombre del usuario que reporta">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="AFFECTED_IP">IP Afectada</span>
                                                </label>
                                                <input type="text" class="form-control" id="incidentAffectedIP"
                                                       data-i18n-placeholder="AFFECTED_IP_PLACEHOLDER"
                                                       placeholder="192.168.1.100">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="AFFECTED_HOSTNAME">Hostname Afectado</span>
                                                </label>
                                                <input type="text" class="form-control" id="incidentAffectedHost"
                                                       data-i18n-placeholder="AFFECTED_HOSTNAME_PLACEHOLDER"
                                                       placeholder="PC-USER-01">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 2: Detección -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingDetection">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapseDetection" aria-expanded="false" aria-controls="collapseDetection">
                                        <strong data-i18n="DETECTION_INFO">Información de Detección</strong>
                                    </button>
                                </h2>
                                <div id="collapseDetection" class="accordion-collapse collapse" 
                                     aria-labelledby="headingDetection" data-bs-parent="#incidentFormAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="DETECTION_CHANNEL">Canal de Detección</span> <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentDetectionChannel" required>
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="CONFIDENCE_LEVEL">Nivel de Confianza</span>
                                                </label>
                                                <select class="form-select" id="incidentConfidence">
                                                    <option value="HIGH" data-i18n="CONFIDENCE_HIGH">Alto</option>
                                                    <option value="MEDIUM" selected data-i18n="CONFIDENCE_MEDIUM">Medio</option>
                                                    <option value="LOW" data-i18n="CONFIDENCE_LOW">Bajo</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 3: Clasificación Técnica -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingClassification">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapseClassification" aria-expanded="false" aria-controls="collapseClassification">
                                        <strong data-i18n="TECHNICAL_CLASSIFICATION">Clasificación Técnica</strong>
                                    </button>
                                </h2>
                                <div id="collapseClassification" class="accordion-collapse collapse" 
                                     aria-labelledby="headingClassification" data-bs-parent="#incidentFormAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <span data-i18n="TYPE">Tipo de Incidente</span> <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentType" required>
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <span data-i18n="AREA">Área Organizacional</span> <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentArea" required>
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <span data-i18n="NIST_PHASE">Fase NIST 800-61</span>
                                                </label>
                                                <select class="form-select" id="incidentNistPhase">
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <span data-i18n="MITRE_TACTIC">Táctica MITRE ATT&CK</span>
                                                </label>
                                                <select class="form-select" id="incidentMitreTactic">
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 4: Clasificación SGSI -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingSGSI">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapseSGSI" aria-expanded="false" aria-controls="collapseSGSI">
                                        <strong data-i18n="SGSI_CLASSIFICATION">Clasificación SGSI (ISO 27035)</strong>
                                    </button>
                                </h2>
                                <div id="collapseSGSI" class="accordion-collapse collapse" 
                                     aria-labelledby="headingSGSI" data-bs-parent="#incidentFormAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="IMPACT">Impacto</span> <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentImpact" required>
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                    <option value="Localized" data-i18n="IMPACT_LOCALIZED">Menor / Localizado</option>
                                                    <option value="Limited" data-i18n="IMPACT_LIMITED">Moderado / Limitado</option>
                                                    <option value="Wide" data-i18n="IMPACT_WIDE">Significativo / Amplio</option>
                                                    <option value="Extensive" data-i18n="IMPACT_EXTENSIVE">Extenso / Generalizado</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="URGENCY">Urgencia</span> <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentUrgency" required>
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                    <option value="Low" data-i18n="URGENCY_LOW_F">Baja</option>
                                                    <option value="Medium" data-i18n="URGENCY_MEDIUM_F">Media</option>
                                                    <option value="High" data-i18n="URGENCY_HIGH_F">Alta</option>
                                                    <option value="Critical" data-i18n="URGENCY_CRITICAL_F">Crítica</option>
                                                </select>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <span data-i18n="SGSI_CATEGORY">Categoría SGSI</span>
                                                </label>
                                                <select class="form-select" id="incidentSgsiCategory">
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="alert alert-info mb-0">
                                                    <strong data-i18n="PRIORITY">Prioridad</strong>: 
                                                    <span id="calculatedPriority" class="badge bg-secondary" data-i18n="NOT_CALCULATED">Sin calcular</span>
                                                    <br><small class="text-muted" data-i18n="PRIORITY_AUTO">Se calcula automáticamente según Impacto x Urgencia</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 5: Asignación y Seguimiento -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingAssignment">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapseAssignment" aria-expanded="false" aria-controls="collapseAssignment">
                                        <strong data-i18n="ASSIGNMENT_TRACKING">Asignación y Seguimiento</strong>
                                    </button>
                                </h2>
                                <div id="collapseAssignment" class="accordion-collapse collapse" 
                                     aria-labelledby="headingAssignment" data-bs-parent="#incidentFormAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="STATUS">Estado</span> <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentStatus" required>
                                                    <option value="" data-i18n="SELECT_PLACEHOLDER">-- Seleccionar --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="ASSIGN_TO">Asignado a</span>
                                                </label>
                                                <input type="text" class="form-control" id="incidentAssignedTo"
                                                       data-i18n-placeholder="ASSIGNED_TO_PLACEHOLDER"
                                                       placeholder="Analista SOC, Administrador, etc.">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="SLA">SLA (horas)</span>
                                                </label>
                                                <input type="number" class="form-control" id="incidentSLA" min="1"
                                                       placeholder="24">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">
                                                    <span data-i18n="ESTIMATED_RESOLUTION">Resolución Estimada</span>
                                                </label>
                                                <input type="datetime-local" class="form-control" id="incidentEstimatedResolution">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 6: Evidencias e IoCs -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingEvidence">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapseEvidence" aria-expanded="false" aria-controls="collapseEvidence">
                                        <strong data-i18n="EVIDENCE_IOCS">Evidencias e Indicadores de Compromiso (IoCs)</strong>
                                    </button>
                                </h2>
                                <div id="collapseEvidence" class="accordion-collapse collapse" 
                                     aria-labelledby="headingEvidence" data-bs-parent="#incidentFormAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <span data-i18n="MALICIOUS_IPS">IPs Maliciosas</span>
                                                </label>
                                                <textarea class="form-control" id="incidentMaliciousIPs" rows="2"
                                                          data-i18n-placeholder="MALICIOUS_IPS_PLACEHOLDER"
                                                          placeholder="192.168.1.50, 10.0.0.100 (separadas por comas)"></textarea>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <span data-i18n="FILE_HASHES">Hashes de Archivos</span>
                                                </label>
                                                <textarea class="form-control" id="incidentFileHashes" rows="2"
                                                          data-i18n-placeholder="FILE_HASHES_PLACEHOLDER"
                                                          placeholder="SHA256: abc123... (separados por comas o saltos de línea)"></textarea>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <span data-i18n="SUSPICIOUS_DOMAINS">Dominios Sospechosos</span>
                                                </label>
                                                <textarea class="form-control" id="incidentSuspiciousDomains" rows="2"
                                                          data-i18n-placeholder="SUSPICIOUS_DOMAINS_PLACEHOLDER"
                                                          placeholder="malicious-site.com, phishing-page.net (separados por comas)"></textarea>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <span data-i18n="ARTIFACTS">Artefactos Adicionales</span>
                                                </label>
                                                <textarea class="form-control" id="incidentArtifacts" rows="3"
                                                          data-i18n-placeholder="ARTIFACTS_PLACEHOLDER"
                                                          placeholder="URLs, nombres de procesos, rutas de archivos, etc."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 7: Línea de Tiempo de Acciones -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingActions">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapseActions" aria-expanded="false" aria-controls="collapseActions">
                                        <strong data-i18n="ACTIONS_TIMELINE">Línea de Tiempo de Acciones</strong>
                                    </button>
                                </h2>
                                <div id="collapseActions" class="accordion-collapse collapse" 
                                     aria-labelledby="headingActions" data-bs-parent="#incidentFormAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <span data-i18n="CONTAINMENT">Contención</span>
                                                </label>
                                                <textarea class="form-control" id="incidentContainment" rows="3"
                                                          data-i18n-placeholder="CONTAINMENT_PLACEHOLDER"
                                                          placeholder="Acciones tomadas para contener el incidente"></textarea>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <span data-i18n="ANALYSIS">Análisis</span>
                                                </label>
                                                <textarea class="form-control" id="incidentAnalysis" rows="3"
                                                          data-i18n-placeholder="ANALYSIS_PLACEHOLDER"
                                                          placeholder="Análisis técnico realizado"></textarea>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <span data-i18n="REMEDIATION">Remediación</span>
                                                </label>
                                                <textarea class="form-control" id="incidentRemediation" rows="3"
                                                          data-i18n-placeholder="REMEDIATION_PLACEHOLDER"
                                                          placeholder="Acciones de remediación aplicadas"></textarea>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <span data-i18n="LESSONS_LEARNED">Lecciones Aprendidas</span>
                                                </label>
                                                <textarea class="form-control" id="incidentLessons" rows="3"
                                                          data-i18n-placeholder="LESSONS_PLACEHOLDER"
                                                          placeholder="Lecciones aprendidas y mejoras a implementar"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="CANCEL">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveIncidentBtn" data-i18n="SAVE">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/taxonomy-cs.js"></script>
    <script src="js/incidents.js"></script>
    <script>
        // Protección de acceso - solo administradores
        Auth.requireAdmin();

        // Inicializar gestor de incidencias
        document.addEventListener('DOMContentLoaded', function() {
            // IncidentManager.init() se llama automáticamente desde incidents.js
            
            // Aplicar traducciones al cargar la página
            const savedLang = localStorage.getItem("osintLanguage") || "es";
            Translations.setLanguage(savedLang);
            
            // Mostrar nombre de usuario en navbar
            const currentUser = Auth.getCurrentUser();
            if (currentUser) {
                document.getElementById('currentUserName').textContent = currentUser.username;
            }
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                Auth.logout();
                window.location.href = 'login.html';
            });

            // Poblar selects cuando se abre el modal
            const incidentModal = document.getElementById('incidentModal');
            incidentModal.addEventListener('shown.bs.modal', function () {
                IncidentManager.populateFormSelects();
            });
        });

        // Toggle de Tema (Dark/Light Mode)
        const themeToggle = document.getElementById("themeToggle");
        const body = document.body;
        const iconLight = document.getElementById("iconLight");
        const iconDark = document.getElementById("iconDark");

        const savedTheme = localStorage.getItem("theme") || "dark";
        body.setAttribute("data-bs-theme", savedTheme);
        updateThemeIcon();

        themeToggle.addEventListener("click", () => {
            const currentTheme = body.getAttribute("data-bs-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            body.setAttribute("data-bs-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            updateThemeIcon();
        });

        function updateThemeIcon() {
            const currentTheme = body.getAttribute("data-bs-theme");
            if (currentTheme === "dark") {
                iconLight.style.display = "block"; // Mostrar sol en modo oscuro
                iconDark.style.display = "none";
            } else {
                iconLight.style.display = "none";
                iconDark.style.display = "block"; // Mostrar luna en modo claro
            }
        }

        // Toggle de Idioma (ES/EN)
        const langToggle = document.getElementById("langToggle");
        const langText = document.getElementById("langText");

        // Inicializar texto del botón según idioma guardado
        const initialLang = localStorage.getItem("osintLanguage") || "es";
        langText.textContent = initialLang === "es" ? "EN" : "ES";

        langToggle.addEventListener("click", () => {
            const currentLang = Translations.currentLanguage;
            const newLang = currentLang === "es" ? "en" : "es";
            Translations.setLanguage(newLang);
            langText.textContent = newLang === "es" ? "EN" : "ES";
            
            // Re-poblar filtros con nuevo idioma
            IncidentManager.populateFilters();
            
            // Re-renderizar incidencias para actualizar traducciones
            IncidentManager.renderIncidents();
            IncidentManager.updateStats();
        });
    </script>
</body>

</html>
